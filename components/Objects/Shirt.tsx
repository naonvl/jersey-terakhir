/*
Auto-generated by: https://github.com/pmndrs/gltfjsx
*/

import * as THREE from 'three'
import { useFrame, useLoader, useThree } from '@react-three/fiber'
import React, {
  useState,
  useRef,
  useEffect,
  Dispatch,
  SetStateAction,
} from 'react'
import { PerspectiveCamera, useGLTF } from '@react-three/drei'
import { TextureLoader } from 'three/src/loaders/TextureLoader'
import { DDSLoader } from 'three/examples/jsm/loaders/DDSLoader'
import { GLTF } from 'three-stdlib'
import { fabric } from 'fabric'
import { useTimer } from 'use-timer'
import initCanvas from '@utils/initCanvas'
import loadSvg from '@utils/loadSvg'

type GLTFResult = GLTF & {
  nodes: {
    M740158_mesh_band: THREE.Mesh
    M740158_mesh_in: THREE.Mesh
    M740158_mesh_out: THREE.Mesh
    M740158_mesh_zipp: THREE.Mesh
    M740158_mesh_zipper: THREE.Mesh
  }
  materials: {}
}

interface ShirtProps {
  props?: JSX.IntrinsicElements['group']
  texturePath: number
  setLoading: Dispatch<SetStateAction<boolean>>
}

const width = 1024
const height = 1024

const Shirt: React.FC<ShirtProps> = ({ props, texturePath, setLoading }) => {
  const { gl } = useThree()
  // const cam = useRef<THREE.PerspectiveCamera>(null)
  const groupRef = useRef<THREE.Group>(null)
  const canvasRef = useRef<fabric.Canvas | null>(null)
  const texture = useRef<THREE.Texture | null>(null)

  // Textures
  const [normalMap] = useLoader(DDSLoader, ['/textures/Jersey_NORMAL.dds'])
  const [aoMapout] = useLoader(TextureLoader, ['/textures/ao_out.png'])
  const [aoMapzipp] = useLoader(TextureLoader, ['/textures/ao_zip.png'])

  const [hovered, setHovered] = useState(false)
  const [clicked, setClicked] = useState(false)

  const { nodes } = useGLTF('/S-cycling-jersey.drc.glb') as GLTFResult
  // const { start, pause, reset, status } = useTimer()

  useEffect(() => {
    canvasRef.current = initCanvas({
      width,
      height,
    })

    loadSvg({
      path: texturePath,
      canvas: canvasRef,
      width,
      height,
      setLoading,
    })

    // start()
    // if (cam.current) {
    //   cam.current.lookAt(1, 0, 0)
    // }

    // cleanup
    return () => {
      canvasRef.current?.dispose()
      canvasRef.current = null
    }
  }, [setLoading, texturePath])

  useFrame((state) => {
    if (canvasRef.current) {
      texture.current = new THREE.Texture(canvasRef.current.getElement())
      texture.current.anisotropy = gl.capabilities.getMaxAnisotropy()
      texture.current.needsUpdate = true
      texture.current.flipY = false

      texture.current.needsUpdate = true
    }

    // if (status === 'RUNNING' && groupRef.current) {
    //   groupRef.current.rotation.y += -0.05
    // }

    // if (
    //   groupRef.current &&
    //   groupRef.current.rotation.y === -6.299999999999986
    // ) {
    //   pause()
    //   reset()
    // }
    state.gl.domElement.style.cursor = hovered ? 'grab' : 'auto'
    state.gl.domElement.style.cursor = clicked ? 'grabbing' : 'grab'
  })

  return (
    <group
      ref={groupRef}
      dispose={null}
      onPointerOver={() => setHovered(true)}
      onPointerOut={() => setHovered(false)}
      onPointerDown={() => setClicked(true)}
      onPointerUp={() => setClicked(false)}
      {...props}
    >
      <mesh
        geometry={nodes.M740158_mesh_band.geometry}
        material={nodes.M740158_mesh_band.material}
        scale={100}
      >
        <meshStandardMaterial
          attach="material"
          normalMap={normalMap}
          normalMap-flipY={false}
          map={texture.current}
        >
          <texture attach="map" image={canvasRef} />
        </meshStandardMaterial>
      </mesh>
      <mesh
        geometry={nodes.M740158_mesh_in.geometry}
        material={nodes.M740158_mesh_in.material}
        scale={100}
      >
        <meshStandardMaterial
          attach="material"
          normalMap={normalMap}
          normalMap-flipY={false}
          map={texture.current}
          color="#fff"
        />
      </mesh>
      <mesh
        geometry={nodes.M740158_mesh_out.geometry}
        material={nodes.M740158_mesh_out.material}
        scale={100}
      >
        <meshStandardMaterial
          attach="material"
          normalMap={normalMap}
          normalMap-flipY={false}
          map={texture.current}
          aoMap={aoMapout}
          aoMapIntensity={0.7}
        >
          <texture attach="map" image={canvasRef} ref={texture} />
        </meshStandardMaterial>
      </mesh>
      <mesh
        geometry={nodes.M740158_mesh_zipp.geometry}
        material={nodes.M740158_mesh_zipp.material}
        position={[0, -1.05, 4.19]}
        rotation={[-0.24, 0, 0]}
        scale={100}
      >
        <meshStandardMaterial
          attach="material"
          normalMap={normalMap}
          normalMap-flipY={false}
          map={texture.current}
          aoMap={aoMapzipp}
          aoMapIntensity={0.7}
        >
          <texture attach="map" image={canvasRef} />
        </meshStandardMaterial>
      </mesh>
      <mesh
        geometry={nodes.M740158_mesh_zipper.geometry}
        material={nodes.M740158_mesh_zipper.material}
        scale={100}
      >
        <meshStandardMaterial
          attach="material"
          normalMap={normalMap}
          normalMap-flipY={false}
          map={texture.current}
          aoMap={aoMapzipp}
          aoMapIntensity={0.7}
        >
          <texture attach="map" image={canvasRef} />
        </meshStandardMaterial>
      </mesh>
      {/* <PerspectiveCamera ref={cam} position={[0, 0, 0]} /> */}
    </group>
  )
}

useGLTF.preload('/cycling-jersey.drc.glb')

export default Shirt
